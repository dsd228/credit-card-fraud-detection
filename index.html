<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Credit Card Fraud Detection · Portfolio Profesional</title>
  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- Plotly.js -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    /* ... estilos igual que antes, omito para brevedad ... */
    body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background: linear-gradient(120deg, #0f2027 0%, #2c5364 100%); color: #f4f6fa; min-height: 100vh;}
    .navbar { background: rgba(44, 83, 100, 0.95); border-bottom: 1px solid #2c5364;}
    .hero { background: linear-gradient(120deg, rgba(44,83,100,.8) 0%, rgba(15,32,39,.9) 100%); border-radius: 1.5rem; margin-top: 2rem; padding: 4rem 2rem; box-shadow: 0 4px 24px 0 rgba(0,0,0,0.3); text-align: center;}
    h2 { color: #00fff1; font-weight: 800; font-size: 2rem;}
    .icon-title { font-size: 2.5rem; vertical-align: middle; margin-right: 0.5rem;}
    .section { margin: 3rem 0; background: rgba(44,83,100,0.7); border-radius: 1.25rem; box-shadow: 0 2px 12px 0 rgba(0,0,0,0.18); padding: 2.5rem 2rem;}
    @media (max-width: 768px) { .hero { padding: 2rem 1rem; } .section { padding: 1.3rem 1rem; } h1 { font-size: 2.2rem; } h2 { font-size: 1.3rem; } }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#"><i class="fas fa-shield-alt icon-title"></i>Credit Fraud AI</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="#datos">Datos</a></li>
          <li class="nav-item"><a class="nav-link" href="#comparacion">Comparación</a></li>
          <li class="nav-item"><a class="nav-link" href="#avanzado">Avanzado</a></li>
          <li class="nav-item"><a class="nav-link" href="#shap">SHAP</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Hero -->
  <section class="hero">
    <div class="container">
      <h1>Credit Card Fraud Detection</h1>
      <p class="lead">Machine Learning aplicado para detectar transacciones fraudulentas en tiempo real.</p>
      <a href="https://github.com/dsd228/credit-card-fraud-detection" class="btn btn-primary btn-lg mt-3" target="_blank"><i class="fab fa-github"></i> Ver Código</a>
    </div>
  </section>

  <!-- Filtros globales -->
  <section class="section" id="filtros">
    <div class="container">
      <h2><i class="fas fa-filter icon-title"></i>Filtros globales</h2>
      <div class="row mb-3">
        <div class="col-md-3">
          <label for="modelo-selector" class="form-label">Modelo:</label>
          <select id="modelo-selector" class="form-select mb-3">
            <option value="randomforest" selected>Random Forest</option>
            <option value="xgboost">XGBoost</option>
            <option value="mlp">MLP</option>
            <option value="logreg">Regresión Logística</option>
          </select>
        </div>
        <div class="col-md-3">
          <label for="threshold-slider" class="form-label">Threshold de decisión:</label>
          <input type="range" class="form-range mb-2" min="0.1" max="0.9" step="0.01" id="threshold-slider">
          <div id="threshold-value" class="mb-2">0.5</div>
        </div>
        <div class="col-md-3">
          <label for="variable-selector" class="form-label">Variable para importancia:</label>
          <select id="variable-selector" class="form-select">
            <option value="all" selected>Todas</option>
            <option value="V1">V1</option>
            <option value="V2">V2</option>
            <option value="V3">V3</option>
            <option value="Amount">Amount</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Comparador de gráficos interactivos -->
  <section class="section" id="comparacion">
    <div class="container">
      <h2 class="text-center mb-4"><i class="fas fa-object-group icon-title"></i>Comparar Gráficos</h2>
      <div class="row mb-4 justify-content-center">
        <div class="col-md-5 mb-3">
          <label class="form-label fw-bold" for="grafico-left">Gráfico izquierdo</label>
          <select id="grafico-left" class="form-select form-select-lg">
            <option value="pie" selected>Distribución de Clases</option>
            <option value="hist">Histograma de Montos</option>
            <option value="roc">Curva ROC</option>
          </select>
          <div id="explicacion-left" class="mt-2 text-secondary"></div>
          <div id="plotly-left" style="height:400px;"></div>
          <button class="btn btn-outline-info mt-2" onclick="exportGraph('plotly-left','grafico_izq')">Exportar PNG</button>
        </div>
        <div class="col-md-5 mb-3">
          <label class="form-label fw-bold" for="grafico-right">Gráfico derecho</label>
          <select id="grafico-right" class="form-select form-select-lg">
            <option value="pie">Distribución de Clases</option>
            <option value="hist" selected>Histograma de Montos</option>
            <option value="roc">Curva ROC</option>
          </select>
          <div id="explicacion-right" class="mt-2 text-secondary"></div>
          <div id="plotly-right" style="height:400px;"></div>
          <button class="btn btn-outline-info mt-2" onclick="exportGraph('plotly-right','grafico_der')">Exportar PNG</button>
        </div>
      </div>
      <div class="row justify-content-center mb-2">
        <div class="col-md-10 text-end">
          <button id="sync-ejes" class="btn btn-outline-info">
            <i class="fas fa-link"></i> Sincronizar Zoom/Navegación
          </button>
          <span id="sync-status" class="ms-2 text-info"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Visualización avanzada -->
  <section class="section" id="avanzado">
    <div class="container">
      <h2 class="text-center mb-4"><i class="fas fa-microscope icon-title"></i>Visualización Avanzada</h2>
      <div class="row g-4">
        <div class="col-md-6">
          <h5><i class="fas fa-th-large"></i> Matriz de Confusión</h5>
          <div id="plotly-confusion" style="height:350px;"></div>
          <button class="btn btn-outline-info mt-2" onclick="exportGraph('plotly-confusion','matriz_confusion')">Exportar PNG</button>
        </div>
        <div class="col-md-6">
          <h5><i class="fas fa-sort-amount-up"></i> Importancia de Variables</h5>
          <div id="plotly-importance" style="height:350px;"></div>
          <button class="btn btn-outline-info mt-2" onclick="exportGraph('plotly-importance','importancia_variables')">Exportar PNG</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SHAP -->
  <section class="section" id="shap">
    <div class="container">
      <h2 class="text-center mb-4"><i class="fas fa-atom icon-title"></i>Interpretabilidad (SHAP)</h2>
      <div id="plotly-shap" style="height:400px;"></div>
      <button class="btn btn-outline-info mt-2" onclick="exportGraph('plotly-shap','shap_importance')">Exportar PNG</button>
    </div>
  </section>

  <!-- Scripts principales -->
  <script>
    // Estado global centralizado
    const appState = {
      modelo: 'randomforest',
      threshold: 0.5,
      variable: 'all'
    };

    // Simulación de endpoints backend (reemplázalos por fetch a tu API real)
    async function fetchConfusion(model, threshold) {
      // return await fetch(`/api/confusion?model=${model}&threshold=${threshold}`).then(r=>r.json());
      // Demo:
      return {matrix:[[28000,80],[45,367]],labels:["No Fraude","Fraude"]};
    }
    async function fetchImportance(model, variable) {
      // return await fetch(`/api/importance?model=${model}&variable=${variable}`).then(r=>r.json());
      // Demo:
      let all = [
        {variable: "V1", importance: 0.18},
        {variable: "V2", importance: 0.13},
        {variable: "V3", importance: 0.12},
        {variable: "Amount", importance: 0.11}
      ];
      return variable==='all'?all:all.filter(d=>d.variable===variable);
    }
    async function fetchSHAP(model) {
      // return await fetch(`/api/shap?model=${model}`).then(r=>r.json());
      // Demo:
      return [{feature:"V1", value:0.25},{feature:"V2", value:0.18},{feature:"Amount", value:0.09}];
    }

    // Visualizaciones
    async function renderConfusion() {
      const {matrix, labels} = await fetchConfusion(appState.modelo, appState.threshold);
      const data = [{
        z: matrix, x: labels, y: labels, type: 'heatmap',
        colorscale: [[0, '#008cff'], [1, '#ff4b5c']], showscale: false,
        hovertemplate: '%{y} predicho como %{x}: %{z}<extra></extra>'
      }];
      const layout = {title:'Matriz de Confusión',font:{color:'#00fff1'},paper_bgcolor:'rgba(44,83,100,0.9)',margin:{t:38,r:10,l:10,b:38}};
      Plotly.newPlot('plotly-confusion', data, layout, {responsive:true});
    }

    async function renderImportance() {
      const dataRaw = await fetchImportance(appState.modelo, appState.variable);
      const data = [{
        x: dataRaw.map(d=>d.variable), y: dataRaw.map(d=>d.importance), type: 'bar',
        marker: {color:'#00fff1'}, text: dataRaw.map(d=>d.importance), textposition:'auto'
      }];
      const layout = {title:'Importancia de Variables',font:{color:'#00fff1'},paper_bgcolor:'rgba(44,83,100,0.9)',yaxis:{title:'Importancia',range:[0,0.3]},margin:{t:38,r:10,l:10,b:38}};
      Plotly.newPlot('plotly-importance', data, layout, {responsive:true});
    }

    async function renderSHAP() {
      const shap_values = await fetchSHAP(appState.modelo);
      const data = [{
        x: shap_values.map(d=>d.feature), y: shap_values.map(d=>d.value), type: "bar",
        marker: {color: "#ff4b5c"}, text: shap_values.map(d=>d.value), textposition: "auto"
      }];
      const layout = {title:"Importancia SHAP",font:{color:'#00fff1'},paper_bgcolor:'rgba(44,83,100,0.9)'};
      Plotly.newPlot("plotly-shap", data, layout, {responsive: true});
    }

    // Comparador de gráficos
    function getGraphData(type) {
      if (type === 'pie') {
        return {data:[{values: [284315, 492], labels: ['No Fraude', 'Fraude'], type: 'pie', marker: { colors: ['#00fff1','#ff4b5c'] }}],
          layout: {title: 'Distribución de Clases',paper_bgcolor:'rgba(44,83,100,0.9)',font:{color:'#00fff1'},showlegend:true}};
      } else if (type === 'hist') {
        return {data:[{x:[12,15,32,60,80,99,120,150,170,200,220,300,360,410,510,600,1000,1500,2000],type:'histogram',marker:{color:'#00fff1'}}],
          layout: {title: 'Histograma de Montos',paper_bgcolor:'rgba(44,83,100,0.9)',font:{color:'#00fff1'},xaxis:{title:'Monto'},yaxis:{title:'Frecuencia'}}};
      } else if (type === 'roc') {
        return {data:[
          {x:[0,0.01,0.02,0.05,0.1,0.2,0.5,1],y:[0,0.6,0.8,0.87,0.92,0.97,0.99,1],type:'scatter',mode:'lines+markers',name:'ROC Curve',line:{color:'#00fff1'}},
          {x:[0,1],y:[0,1],type:'scatter',mode:'lines',name:'Random',line:{dash:'dot',color:'#888'}}
        ],
        layout: {title:'Curva ROC',paper_bgcolor:'rgba(44,83,100,0.9)',font:{color:'#00fff1'},xaxis:{title:'FPR'},yaxis:{title:'TPR'},showlegend:true}};
      }
    }
    function drawGraph(side, type) {
      const config = getGraphData(type);
      Plotly.newPlot(`plotly-${side}`, config.data, config.layout, {responsive:true});
      document.getElementById('explicacion-' + side).textContent = config.layout.title;
    }

    // Exportación
    function exportGraph(graphDivId, filename='grafico') {
      Plotly.downloadImage(document.getElementById(graphDivId), {format:'png',filename:filename,width:1000,height:600});
    }

    // Sincronización de ejes
    let syncActive = false;
    function syncHandler() {
      syncActive = !syncActive;
      document.getElementById('sync-status').textContent = syncActive ? 'Sincronización activada' : 'Sincronización desactivada';
      if (syncActive) {
        Plotly.d3.selectAll('#plotly-left, #plotly-right').on('plotly_relayout', function(event) {
          const source = this.id;
          const target = source === 'plotly-left' ? 'plotly-right' : 'plotly-left';
          const leftType = document.getElementById('grafico-left').value;
          const rightType = document.getElementById('grafico-right').value;
          if (leftType === rightType && leftType !== 'pie') {
            Plotly.relayout(target, event.detail);
          }
        });
      } else {
        Plotly.d3.selectAll('#plotly-left, #plotly-right').on('plotly_relayout', null);
      }
    }

    // Render global
    async function renderAll() {
      document.getElementById('threshold-value').textContent = appState.threshold.toFixed(2);
      drawGraph('left', document.getElementById('grafico-left').value);
      drawGraph('right', document.getElementById('grafico-right').value);
      await renderConfusion();
      await renderImportance();
      await renderSHAP();
    }

    // Listeners globales
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('modelo-selector').addEventListener('change', (e)=>{
        appState.modelo = e.target.value; renderAll();
      });
      document.getElementById('threshold-slider').addEventListener('input', (e)=>{
        appState.threshold = parseFloat(e.target.value); renderAll();
      });
      document.getElementById('variable-selector').addEventListener('change', (e)=>{
        appState.variable = e.target.value; renderAll();
      });
      document.getElementById('grafico-left').addEventListener('change', ()=>drawGraph('left', document.getElementById('grafico-left').value));
      document.getElementById('grafico-right').addEventListener('change', ()=>drawGraph('right', document.getElementById('grafico-right').value));
      document.getElementById('sync-ejes').addEventListener('click', syncHandler);
      document.getElementById('threshold-slider').value = appState.threshold;
      renderAll();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
